pipeline {
    agent any

    environment {
        GITHUB_TOKEN = credentials('token')
        VENV_DIR = ".venv"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/yasminerahhaoui/Jenkins-CI-CD.git',
                    credentialsId: 'token'
            }
        }

        stage('Setup Virtual Environment') {
            steps {
                bat """
                python -m venv ${VENV_DIR}
                call ${VENV_DIR}\\Scripts\\activate
                python -m pip install --upgrade pip
                pip install -r requirements.txt
                """
            }
        }

        stage('Run Tests') {
            when {
                not { changeset "README.md" }
            }
            steps {
                script {
                    parallel(
                        "Test File 1": {
                            bat """
                            call ${VENV_DIR}\\Scripts\\activate
                            pytest test_app.py -v
                            """
                        },
                        "Test File 2": {
                            bat """
                            call ${VENV_DIR}\\Scripts\\activate
                            pytest test_app_2.py -v
                            """
                        }
                    )
                }
            }
        }

        stage('Deploy') {
            steps {
                echo "Deploy skipped on Windows"
            }
        }
    }

    post {
        success {
            emailext(
                to: "yasminerahhaoui42@gmail.com",
                from: "jenkins@gmail.com",
                replyTo: "jenkins@gmail.com",
